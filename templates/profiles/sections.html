{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Manage Sections | BioStack{% endblock %}

{% block dashboard_content %}

  <script src="{% static 'js/Sortable.min.js' %}"></script>  
  <style>
    /* Kept your specific styles */
    input[type="date"] { color-scheme: dark; }
    .draggable-item { cursor: grab; touch-action: none; }
    .draggable-item:active { cursor: grabbing; }
    .group-handle { cursor: move; }
    .sortable-ghost { opacity: 0.4; background-color: #312e81; border: 2px dashed #6366f1; }
    
    /* Universal Form Styling */
    .django-field-group input, .django-field-group textarea, .django-field-group select {
        width: 100%; background-color: #1e293b; border: 1px solid #334155;
        color: white; border-radius: 0.75rem; padding: 0.75rem 1rem;
        outline: none; transition: all 0.2s;
    }
    .django-field-group input:focus, .django-field-group select:focus {
        border-color: #6366f1; background-color: #0f172a;
    }
    .django-field-group input[type="checkbox"] { width: 1.25rem; height: 1.25rem; accent-color: #6366f1; }
  </style>

  <div class="fade-in-up">
    
      
    <div class="flex flex-col md:flex-row justify-between gap-4 mb-8">
      <div>
        <h2 class="text-3xl font-bold text-white">Profile Sections</h2>
        <p class="text-slate-400 mt-2">Create content and organize your profile structure.</p>
      </div>
      <a href="{% url 'profiles:list' %}" class="flex items-center gap-2 px-4 py-2 border border-white/10 rounded-lg hover:bg-white/5 text-sm text-slate-300 transition">
        <i class="fa-solid fa-arrow-left"></i> Back
      </a>
    </div>
    <div class='mb-4'>
        <p class="text-slate-400 mt-2 text-lg flex items-center gap-2">
          Active Profile: 
          <span class="text-white font-semibold border-b border-indigo-500/50 pb-0.5">
              {% if profile %}
                  {{ profile.full_name|default:profile.slug }}
              {% else %}
                  No Active Profile
              {% endif %}
          </span>
        </p>
      </div>


    <div class="p-8 rounded-3xl bg-slate-900/50 border border-white/10 shadow-2xl mb-12 relative overflow-hidden">
      <div class="relative z-10">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fa-solid fa-plus-circle text-indigo-500"></i>
            Add New Section
        </h3>

        <form method="post" id="section-form" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="grid gap-5">
            
            <div class="django-field-group">
                <label class="block text-sm text-slate-400 mb-2">Section Type</label>
                {{ form.section_type }}
            </div>

            <div id="group-title" class="django-field-group">
                <label id="label-title" class="block text-sm text-slate-400 mb-2">Title</label>
                {{ form.title }}
            </div>

            <div id="group-experience" class="hidden space-y-5 p-5 bg-slate-800/50 rounded-xl border border-white/5">
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.position.label }}</label>
                    {{ form.position }}
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="django-field-group">
                        <label class="block text-sm text-slate-400 mb-2">{{ form.start_date.label }}</label>
                        {{ form.start_date }}
                    </div>
                    <div class="django-field-group">
                        <label class="block text-sm text-slate-400 mb-2">{{ form.end_date.label }}</label>
                        {{ form.end_date }}
                    </div>
                </div>
                <div class="django-field-group">
                    <label class="flex items-center gap-3 cursor-pointer">
                        {{ form.is_current }} <span class="text-sm text-slate-300">I currently work here</span>
                    </label>
                </div>
            </div>

            <div id="group-links" class="hidden p-5 bg-slate-800/50 rounded-xl border border-white/5">
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.link_url.label }}</label>
                    {{ form.link_url }}
                </div>
            </div>

            <div id="group-skills" class="hidden space-y-5 p-5 bg-slate-800/50 rounded-xl border border-white/5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="django-field-group">
                        <label class="block text-sm text-slate-400 mb-2">{{ form.skill_name.label }}</label>
                        {{ form.skill_name }}
                    </div>
                    <div class="django-field-group">
                        <label class="block text-sm text-slate-400 mb-2">{{ form.skill_level.label }}</label>
                        {{ form.skill_level }}
                    </div>
                </div>
            </div>

        <div id="group-personal" class="hidden space-y-5 p-5 bg-slate-800/50 rounded-xl border border-white/5">
            
            <div class="flex items-center gap-6 mb-6 pb-6 border-b border-white/5">
                <div class="relative w-24 h-24 rounded-full overflow-hidden border-2 border-indigo-500/30 bg-slate-900 shadow-lg">
                    {% if profile.profile_image %}
                        <img src="{{ profile.profile_image.url }}" class="w-full h-full object-cover" id="preview-image">
                    
                    {% elif request.user.details.profile_image %}
                        <img src="{{ request.user.details.profile_image.url }}" class="w-full h-full object-cover opacity-80" id="preview-image">
                    
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-slate-500 bg-slate-800" id="preview-placeholder">
                            <i class="fa-solid fa-user text-3xl"></i>
                        </div>
                        <img src="" class="hidden w-full h-full object-cover" id="preview-image">
                    {% endif %}

                </div>

                <div class="flex-1">
                    <label class="block text-sm text-slate-400 mb-2 font-medium">Profile Photo</label>
                    <div class="flex items-center gap-4">
                        <label for="id_profile_image" class="cursor-pointer px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition border border-white/10 hover:border-white/30 flex items-center gap-2">
                            <i class="fa-solid fa-camera"></i> Choose Image
                        </label>
                        <span id="file-name" class="text-xs text-slate-500 italic">No file chosen</span>
                        
                        {{ form.profile_image }} 
                    </div>
                    <p class="text-[11px] text-slate-500 mt-2">
                        Supported formats: JPG, PNG. Max size: 5MB.
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.phone.label }}</label>
                    {{ form.phone }}
                </div>
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.email.label }}</label>
                    {{ form.email }}
                </div>
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.dob.label }}</label>
                    {{ form.dob }}
                </div>
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.gender.label }}</label>
                    {{ form.gender }}
                </div>
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.marital_status.label }}</label>
                    {{ form.marital_status }}
                </div>
                <div class="django-field-group">
                    <label class="block text-sm text-slate-400 mb-2">{{ form.nationality.label }}</label>
                    {{ form.nationality }}
                </div>
            </div>
            
            <div class="django-field-group">
                <label class="block text-sm text-slate-400 mb-2">{{ form.address.label }}</label>
                {{ form.address }}
            </div>
            <div class="django-field-group">
                <label class="block text-sm text-slate-400 mb-2">{{ form.location.label }}</label>
                {{ form.location }}
            </div>
        </div>

            <div id="group-content" class="django-field-group">
                <label id="label-content" class="block text-sm text-slate-400 mb-2">Description</label>
                {{ form.content }}
            </div>

            <div class="django-field-group pt-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    {{ form.is_enabled }} <span class="text-sm text-slate-300">Visible on Profile</span>
                </label>
            </div>

          </div>
          <button type="submit" class="mt-8 w-full py-3 bg-gradient-to-r from-indigo-600 to-cyan-600 hover:from-indigo-500 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-500/20">
            Add Section
          </button>
        </form>
      </div>
    </div>

    <h3 class="text-2xl font-bold text-white mb-6">Manage Content</h3>
    
    <div id="main-groups-container" class="space-y-8 pb-12">
        
        <div class="group-block bg-slate-900/30 border border-white/5 p-6 rounded-2xl" data-group-id="PERSONAL">
            <h4 class="text-lg font-bold text-indigo-400 mb-4 pb-2 border-b border-white/5 flex items-center justify-between group-handle cursor-move">
                <span><i class="fa-regular fa-id-card mr-2"></i> Personal Data</span>
                <i class="fa-solid fa-grip-lines text-slate-600 hover:text-white"></i>
            </h4>
            <div id="list-PERSONAL" class="space-y-3 sortable-list min-h-[50px]">
                {% for s in sections %}
                    {% if s.section_type == 'PERSONAL' %}
                        <div class="draggable-item group flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-indigo-500/30 transition" data-id="{{ s.id }}">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="p-2 text-slate-600 cursor-grab hover:text-white"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">{{ s.title }}</h4>
                                    <p class="text-xs text-slate-500">{{ s.data.email }}</p>
                                </div>
                            </div>
                            <form action="{% url 'profiles:delete_section' s.id %}" method="POST" onsubmit="return confirm('Delete?');">{% csrf_token %}<button class="p-2 text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="group-block bg-slate-900/30 border border-white/5 p-6 rounded-2xl" data-group-id="ABOUT">
            <h4 class="text-lg font-bold text-indigo-400 mb-4 pb-2 border-b border-white/5 flex items-center justify-between group-handle cursor-move">
                <span><i class="fa-regular fa-user mr-2"></i> About Me</span>
                <i class="fa-solid fa-grip-lines text-slate-600 hover:text-white"></i>
            </h4>
            <div id="list-ABOUT" class="space-y-3 sortable-list min-h-[50px]">
                {% for s in sections %}
                    {% if s.section_type == 'ABOUT' %}
                        <div class="draggable-item group flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-indigo-500/30 transition" data-id="{{ s.id }}">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="p-2 text-slate-600 cursor-grab hover:text-white"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">{{ s.title }}</h4>
                                    <p class="text-xs text-slate-500 line-clamp-1">{{ s.data.content }}</p>
                                </div>
                            </div>
                            <form action="{% url 'profiles:delete_section' s.id %}" method="POST" onsubmit="return confirm('Delete?');">{% csrf_token %}<button class="p-2 text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="group-block bg-slate-900/30 border border-white/5 p-6 rounded-2xl" data-group-id="EXPERIENCE">
            <h4 class="text-lg font-bold text-indigo-400 mb-4 pb-2 border-b border-white/5 flex items-center justify-between group-handle cursor-move">
                <span><i class="fa-solid fa-briefcase mr-2"></i> Experience</span>
                <i class="fa-solid fa-grip-lines text-slate-600 hover:text-white"></i>
            </h4>
            <div id="list-EXPERIENCE" class="space-y-3 sortable-list min-h-[50px]">
                {% for s in sections %}
                    {% if s.section_type == 'EXPERIENCE' %}
                        <div class="draggable-item group flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-indigo-500/30 transition" data-id="{{ s.id }}">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="p-2 text-slate-600 cursor-grab hover:text-white"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">{{ s.data.position }}</h4>
                                    <p class="text-xs text-slate-500">{{ s.title }}</p>
                                </div>
                            </div>
                            <form action="{% url 'profiles:delete_section' s.id %}" method="POST" onsubmit="return confirm('Delete?');">{% csrf_token %}<button class="p-2 text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="group-block bg-slate-900/30 border border-white/5 p-6 rounded-2xl" data-group-id="PROJECTS">
            <h4 class="text-lg font-bold text-indigo-400 mb-4 pb-2 border-b border-white/5 flex items-center justify-between group-handle cursor-move">
                <span><i class="fa-solid fa-rocket mr-2"></i> Projects</span>
                <i class="fa-solid fa-grip-lines text-slate-600 hover:text-white"></i>
            </h4>
            <div id="list-PROJECTS" class="space-y-3 sortable-list min-h-[50px]">
                {% for s in sections %}
                    {% if s.section_type == 'PROJECTS' %}
                        <div class="draggable-item group flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-indigo-500/30 transition" data-id="{{ s.id }}">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="p-2 text-slate-600 cursor-grab hover:text-white"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">{{ s.title }}</h4>
                                </div>
                            </div>
                            <form action="{% url 'profiles:delete_section' s.id %}" method="POST" onsubmit="return confirm('Delete?');">{% csrf_token %}<button class="p-2 text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="group-block bg-slate-900/30 border border-white/5 p-6 rounded-2xl" data-group-id="SKILLS">
            <h4 class="text-lg font-bold text-indigo-400 mb-4 pb-2 border-b border-white/5 flex items-center justify-between group-handle cursor-move">
                <span><i class="fa-solid fa-microchip mr-2"></i> Skills</span>
                <i class="fa-solid fa-grip-lines text-slate-600 hover:text-white"></i>
            </h4>
            <div id="list-SKILLS" class="space-y-3 sortable-list min-h-[50px]">
                {% for s in sections %}
                    {% if s.section_type == 'SKILLS' %}
                        <div class="draggable-item group flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-indigo-500/30 transition" data-id="{{ s.id }}">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="p-2 text-slate-600 cursor-grab hover:text-white"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">{{ s.data.name }}</h4>
                                    <p class="text-xs text-slate-500">{{ s.data.level }}</p>
                                </div>
                            </div>
                            <form action="{% url 'profiles:delete_section' s.id %}" method="POST" onsubmit="return confirm('Delete?');">{% csrf_token %}<button class="p-2 text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="group-block bg-slate-900/30 border border-white/5 p-6 rounded-2xl" data-group-id="LINKS">
            <h4 class="text-lg font-bold text-indigo-400 mb-4 pb-2 border-b border-white/5 flex items-center justify-between group-handle cursor-move">
                <span><i class="fa-solid fa-link mr-2"></i> Links</span>
                <i class="fa-solid fa-grip-lines text-slate-600 hover:text-white"></i>
            </h4>
            <div id="list-LINKS" class="space-y-3 sortable-list min-h-[50px]">
                {% for s in sections %}
                    {% if s.section_type == 'LINKS' %}
                        <div class="draggable-item group flex items-center justify-between p-4 bg-slate-900 border border-white/5 rounded-xl hover:border-indigo-500/30 transition" data-id="{{ s.id }}">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="p-2 text-slate-600 cursor-grab hover:text-white"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white">{{ s.title }}</h4>
                                    <p class="text-xs text-slate-500">{{ s.data.url }}</p>
                                </div>
                            </div>
                            <form action="{% url 'profiles:delete_section' s.id %}" method="POST" onsubmit="return confirm('Delete?');">{% csrf_token %}<button class="p-2 text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></form>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. THE SAVE FUNCTION ---
        function saveGlobalOrder() {
            const groupContainer = document.getElementById('main-groups-container');
            const groups = Array.from(groupContainer.querySelectorAll('.group-block')); 
            let globalOrderIds = [];
            
            groups.forEach(group => {
                const list = group.querySelector('.sortable-list');
                if(list) {
                    const items = Array.from(list.querySelectorAll('.draggable-item'));
                    items.forEach(item => {
                        const id = parseInt(item.getAttribute('data-id'));
                        if (id) globalOrderIds.push(id);
                    });
                }
            });
            
            console.log("Saving Order:", globalOrderIds); 

            if(globalOrderIds.length > 0) {
                fetch("{% url 'profiles:reorder_sections' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ order: globalOrderIds })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Save Response:", data);
                });
            }
        }

        // --- 2. INITIALIZE ITEM LISTS ---
        const lists = document.querySelectorAll('.sortable-list');
        lists.forEach(list => {
            new Sortable(list, {
                group: 'items', 
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.cursor-grab',
                onEnd: function (evt) {
                    saveGlobalOrder(); 
                }
            });
        });

        // --- 3. INITIALIZE GROUP LIST ---
        const mainContainer = document.getElementById('main-groups-container');
        new Sortable(mainContainer, {
            animation: 150,
            handle: '.group-handle', 
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                saveGlobalOrder(); 
                var order = this.toArray();
                localStorage.setItem(this.options.group.name, order.join('|'));
            },
            store: {
                get: function (sortable) {
                    var order = localStorage.getItem(sortable.options.group.name);
                    return order ? order.split('|') : [];
                },
                set: function (sortable) {
                    var order = sortable.toArray();
                    localStorage.setItem(sortable.options.group.name, order.join('|'));
                }
            },
            group: 'main-groups'
        });

        // --- 4. FORM VISIBILITY (Existing) ---
        const typeSelect = document.querySelector('#id_section_type');
        const groups = {
            'EXPERIENCE': document.getElementById('group-experience'),
            'LINKS': document.getElementById('group-links'),
            'SKILLS': document.getElementById('group-skills'),
            'PERSONAL': document.getElementById('group-personal'),
            'title': document.getElementById('group-title'),
            'content': document.getElementById('group-content')
        };
        const labelContent = document.getElementById('label-content');

        function updateLayout() {
            const type = typeSelect.value;
            Object.values(groups).forEach(g => g && g.classList.add('hidden'));
            groups['title'].classList.remove('hidden');
            groups['content'].classList.remove('hidden');

            if (type === 'EXPERIENCE') groups['EXPERIENCE'].classList.remove('hidden');
            else if (type === 'LINKS') { groups['LINKS'].classList.remove('hidden'); groups['content'].classList.add('hidden'); }
            else if (type === 'SKILLS') { groups['SKILLS'].classList.remove('hidden'); groups['title'].classList.add('hidden'); }
            else if (type === 'PERSONAL') { groups['PERSONAL'].classList.remove('hidden'); groups['title'].classList.add('hidden'); labelContent.textContent = "Short Bio"; }
        }

        if(typeSelect) { typeSelect.addEventListener('change', updateLayout); updateLayout(); }
    });

    // Image Upload Preview Logic
    const imageInput = document.getElementById('id_profile_image');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 1. Update the file name text
                document.getElementById('file-name').textContent = file.name;

                // 2. Read and Preview the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview-image');
                    const placeholder = document.getElementById('preview-placeholder');
                    
                    // Show image, hide placeholder
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    if(placeholder) placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        });
    }
  </script>

{% endblock %}