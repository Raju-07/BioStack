{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Manage Subscription | BioStack{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto fade-in-up">

    <div class="flex flex-col md:flex-row justify-between items-end gap-6 mb-10">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Subscription & Billing</h1>
            <p class="text-slate-400 mt-2 text-sm">Manage your plan, view billing history, and upgrade features.</p>
        </div>
        
        <div class="px-5 py-2 rounded-xl bg-[#0F172A] border border-white/10 flex items-center gap-3">
            <div class="text-right">
                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Current Plan</p>
                <p class="text-white font-bold">{{ request.user.subscription.get_plan_type_display }}</p>
            </div>
            <div class="w-10 h-10 rounded-lg bg-indigo-500/10 flex items-center justify-center border border-indigo-500/20 text-indigo-400">
                {% if request.user.subscription.is_pro %}
                    <i class="fa-solid fa-crown"></i>
                {% else %}
                    <i class="fa-solid fa-leaf"></i>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-r from-slate-900 to-slate-800 border border-white/10 rounded-3xl p-6 md:p-8 mb-12 relative overflow-hidden">
        
        <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-indigo-500/5 rounded-full blur-3xl pointer-events-none"></div>

        <div class="relative z-10 flex flex-col md:flex-row gap-8 items-start md:items-center justify-between">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 shrink-0 border border-indigo-500/20">
                    <i class="fa-solid fa-receipt text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white mb-1">
                        {% if request.user.subscription.is_pro %}
                            You are on the <span class="text-indigo-400">{{ request.user.subscription.get_plan_type_display }}</span>
                        {% else %}
                            You are on the <span class="text-slate-300">Free Starter Plan</span>
                        {% endif %}
                    </h3>
                    
                    <p class="text-slate-400 text-sm">
                        {% if request.user.subscription.is_pro %}
                            Your plan renews on <span class="text-white font-mono">{{ request.user.subscription.end_date|date:"M d, Y" }}</span>.
                        {% else %}
                            Upgrade to remove limits and unlock premium analytics.
                        {% endif %}
                    </p>

                    {% if not request.user.subscription.is_pro %}
                    <div class="mt-4 flex items-center gap-3">
                        <div class="h-2 w-32 bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500" style="width: {% if request.user.profiles.count >= 1 %}100%{% else %}50%{% endif %}"></div>
                        </div>
                        <span class="text-xs text-slate-500">
                            {{ request.user.profiles.count }} / 1 Profile Used
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if not request.user.subscription.is_pro %}
            <button onclick="scrollToPlans()" class="px-6 py-3 bg-white text-slate-900 font-bold rounded-xl hover:scale-105 transition shadow-xl shadow-indigo-500/10 flex items-center gap-2">
                <i class="fa-solid fa-sparkles text-indigo-600"></i> Unlock Pro
            </button>
            {% endif %}
        </div>
    </div>

    <div id="plans-section" class="grid grid-cols-1 md:grid-cols-3 gap-6 relative">
        
        <div class="bg-[#0F172A]/60 backdrop-blur border border-white/5 rounded-3xl p-8 flex flex-col hover:border-white/10 transition group">
            <div class="mb-4">
                <h3 class="text-lg font-bold text-slate-300">Starter</h3>
                <p class="text-xs text-slate-500 uppercase tracking-wider mt-1">For Beginners</p>
            </div>
            <div class="mb-6">
                <span class="text-4xl font-bold text-white">₹0</span>
                <span class="text-slate-500">/forever</span>
            </div>

            <ul class="space-y-3 mb-8 flex-1">
                <li class="flex items-center gap-3 text-slate-300 text-sm"><i class="fa-solid fa-check text-emerald-500"></i> 1 Active Profile</li>
                <li class="flex items-center gap-3 text-slate-300 text-sm"><i class="fa-solid fa-check text-emerald-500"></i> Basic Themes</li>
                <li class="flex items-center gap-3 text-slate-500 text-sm"><i class="fa-solid fa-xmark"></i> Advanced Analytics</li>
                <li class="flex items-center gap-3 text-slate-500 text-sm"><i class="fa-solid fa-xmark"></i> Remove Branding</li>
            </ul>

            {% if request.user.subscription.plan_type == 'FREE' %}
                <button disabled class="w-full py-3 rounded-xl bg-slate-800 text-slate-500 font-bold border border-white/5 cursor-not-allowed">
                    Current Plan
                </button>
            {% else %}
                <button class="w-full py-3 rounded-xl border border-white/20 text-slate-300 hover:bg-white/5 transition font-bold">
                    Downgrade
                </button>
            {% endif %}
        </div>

        <div class="relative bg-slate-900 border border-indigo-500/30 rounded-3xl p-8 flex flex-col shadow-2xl shadow-indigo-500/10 transform md:-translate-y-4 hover:border-indigo-500/50 transition duration-300">
            <div class="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            
            <div class="mb-4 mt-2">
                <h3 class="text-lg font-bold text-white">Pro Monthly</h3>
                <p class="text-xs text-indigo-400 uppercase tracking-wider mt-1 font-bold">Most Flexible</p>
            </div>
            <div class="mb-6">
                <span class="text-4xl font-bold text-white">₹99</span>
                <span class="text-slate-500">/month</span>
            </div>

            <ul class="space-y-3 mb-8 flex-1">
                <li class="flex items-center gap-3 text-white text-sm"><i class="fa-solid fa-check text-indigo-400"></i> <strong>Unlimited Profiles</strong></li>
                <li class="flex items-center gap-3 text-white text-sm"><i class="fa-solid fa-check text-indigo-400"></i> Premium Themes</li>
                <li class="flex items-center gap-3 text-white text-sm"><i class="fa-solid fa-check text-indigo-400"></i> Click & CTR Analytics</li>
                <li class="flex items-center gap-3 text-white text-sm"><i class="fa-solid fa-check text-indigo-400"></i> Remove Branding</li>
                <li class="flex items-center gap-3 text-white text-sm"><i class="fa-solid fa-check text-indigo-400"></i> Custom Templates</li>
            </ul>

            {% if request.user.subscription.plan_type == 'MONTHLY' %}
                <button disabled class="w-full py-3 rounded-xl bg-indigo-600/20 text-indigo-400 font-bold border border-indigo-500/20 cursor-not-allowed flex items-center justify-center gap-2">
                    <i class="fa-solid fa-circle-check"></i> Active
                </button>
            {% else %}
                <button onclick="initiatePayment('MONTHLY')" class="w-full py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition shadow-lg shadow-indigo-500/25 flex items-center justify-center gap-2">
                    Upgrade Monthly <i class="fa-solid fa-arrow-right"></i>
                </button>
            {% endif %}
        </div>

        <div class="bg-[#0F172A]/60 backdrop-blur border border-white/5 rounded-3xl p-8 flex flex-col hover:border-emerald-500/30 transition group">
            <div class="mb-4">
                <h3 class="text-lg font-bold text-emerald-400">Pro Yearly</h3>
                <p class="text-xs text-emerald-600 uppercase tracking-wider mt-1 font-bold">Best Value</p>
            </div>
            <div class="mb-6">
                <span class="text-4xl font-bold text-white">₹899</span>
                <span class="text-slate-500">/year</span>
                <p class="text-[10px] text-emerald-500 mt-2 font-bold bg-emerald-500/10 inline-block px-2 py-1 rounded">Save 25% vs Monthly</p>
            </div>

            <ul class="space-y-3 mb-8 flex-1">
                <li class="flex items-center gap-3 text-slate-300 text-sm"><i class="fa-solid fa-check text-emerald-500"></i> All Pro Features</li>
                <li class="flex items-center gap-3 text-slate-300 text-sm"><i class="fa-solid fa-check text-emerald-500"></i> Priority Support</li>
                <li class="flex items-center gap-3 text-slate-300 text-sm"><i class="fa-solid fa-check text-emerald-500"></i> Early Access to Features</li>
            </ul>

            {% if request.user.subscription.plan_type == 'YEARLY' %}
                <button disabled class="w-full py-3 rounded-xl bg-emerald-500/10 text-emerald-400 font-bold border border-emerald-500/20 cursor-not-allowed flex items-center justify-center gap-2">
                    <i class="fa-solid fa-circle-check"></i> Active
                </button>
            {% else %}
                <button onclick="initiatePayment('YEARLY')" class="w-full py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-bold transition border border-white/10 flex items-center justify-center gap-2">
                    Upgrade Yearly
                </button>
            {% endif %}
        </div>

    </div>

    <div class="mt-20 border-t border-white/5 pt-10">
        <h3 class="text-xl font-bold text-white mb-6 text-center">Frequently Asked Questions</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
            <div class="bg-slate-900/50 p-5 rounded-xl border border-white/5">
                <h4 class="font-bold text-slate-200 mb-2">Can I cancel anytime?</h4>
                <p class="text-slate-400">Yes, you can cancel your subscription at any time. Your pro features will remain active until the end of your billing period.</p>
            </div>
            <div class="bg-slate-900/50 p-5 rounded-xl border border-white/5">
                <h4 class="font-bold text-slate-200 mb-2">What happens to my extra profiles if I downgrade?</h4>
                <p class="text-slate-400">Your extra profiles will be paused (hidden from public) until you upgrade again. You won't lose your data.</p>
            </div>
        </div>
    </div>

</div>

<script>
    function scrollToPlans() {
        document.getElementById('plans-section').scrollIntoView({ behavior: 'smooth' });
    }

    function initiatePayment(planType) {
        // This is where we will hook up Razorpay later
        console.log("User wants to buy:", planType);
        
        // Temporary feedback for UI testing
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        setTimeout(() => {
            alert(`Integration Pending: You selected ${planType}. Payment gateway needed.`);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 1000);
    }
</script>

{% endblock %}